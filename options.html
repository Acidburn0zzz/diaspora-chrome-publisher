<!--
 * Diaspora* Publisher extension.
 * Copyright (C) 2012  Vittorio Cuculo <vittorio.cuculo@gmail.com>
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
-->
<html>
<head>
  <title></title>
<style>
.b1, .b2, .b3, .b4{font-size:1px; overflow:hidden; display:block;}
.b1 {height:1px; background:#888; margin:0 5px;}
.b2 {height:1px; background:#ddd; border-right:2px solid #888; border-left:2px solid #888; margin:0 3px;}
.b3 {height:1px; background:#ddd; border-right:1px solid #888; border-left:1px solid #888; margin:0 2px;}
.b4 {height:2px; background:#ddd; border-right:1px solid #888; border-left:1px solid #888; margin:0 1px;}
.contentb {margin: auto;background: #ddd; border-right:1px solid #888; border-left:1px solid #888;}
.contentb div {margin-left: 5px;font-size: 30px;font-family: Helvetica, Arial, sans-serif;}
.optioninput {font-family: Helvetica, Arial, sans-serif;}
#html, body {
  position: absolute;
  top: 25%;
  left: 25%;
  width: 50%;
  height: 50%;
  background-color: #CCC;
  padding: 5px;
}
</style>
<link type="text/css" href="css/smoothness/jquery-ui-1.8.16.custom.css" rel="Stylesheet" />	
<script type="text/javascript" src="js/jquery.min.js"></script>
<script type="text/javascript" src="js/jquery-ui-1.8.16.custom.min.js"></script>
<script>

var remoteList		= "http://podupti.me/api.php?key=4r45tg";
var localList		= "podlist.txt";
var defaultPlaceholder	= "https://diaspora.eigenlab.org";
var pods = new Array();

function localize() {
  document.title = chrome.i18n.getMessage("optionsTitle");
  $("#choosePod").html(chrome.i18n.getMessage("choosePod"));
  $("#chooseAbove").html(chrome.i18n.getMessage("chooseAbove"));
  $("label[id='addImageOpt']").append(chrome.i18n.getMessage("addImageOpt"));
  $("label[id='addMarkdownOpt']").append(chrome.i18n.getMessage("addMarkdownOpt"));
  $("label[id='addMsgOpt']").append(chrome.i18n.getMessage("addMsgOpt"));
  $("label[id='addTagsOpt']").append(chrome.i18n.getMessage("addTagsOpt"));
  $("label[id='addUrlOpt']").append(chrome.i18n.getMessage("addUrlOpt"));
  $("label[id='addTitleOpt']").append(chrome.i18n.getMessage("addTitleOpt"));
  $("label[id='addYTOpt']").append(chrome.i18n.getMessage("addYTOpt"));
  $("label[id='addVMOpt']").append(chrome.i18n.getMessage("addVMOpt"));
  $("label[id='enableNotify']").append(chrome.i18n.getMessage("enableNotify"));
  $("label[id='checkEvery']").append(chrome.i18n.getMessage("checkEvery"));
  $("label[id='minutes']").append(chrome.i18n.getMessage("minutes"));
  $("label[id='checkNow']").append(chrome.i18n.getMessage("checkNow"));
}

function submit() {
  if (document.getElementById('pod').value != ""){
    window.localStorage.podUrl = document.getElementById('pod').value;
    document.getElementById('pod').placeholder = document.getElementById('pod').value;
  }
  else
    window.localStorage.podUrl = document.getElementById('pod').placeholder;

  saveOption();

  var notification = webkitNotifications.createNotification(
  'icon.png',  // icon url
  chrome.i18n.getMessage("urlSaved"),  // notification title
  ''  // notification body text
  );

  notification.ondisplay = function() {
  setTimeout(function() {
    notification.cancel();
  }, 1000);
  };

  notification.show();
}

function saveOption(){
  window.localStorage.images = document.getElementById('images').checked;
  window.localStorage.msg = document.getElementById('msg').checked;
  window.localStorage.tags = document.getElementById('tags').checked;
  window.localStorage.markdown = document.getElementById('markdown').checked;
  window.localStorage.title = document.getElementById('title').checked;
  window.localStorage.url = document.getElementById('url').checked;
  window.localStorage.ytimg = document.getElementById('ytimg').checked;
  window.localStorage.vmimg = document.getElementById('vmimg').checked;
  window.localStorage.notify = document.getElementById('notify').checked;
  window.localStorage.minutes = document.getElementById('minutes').value;

  var short = document.getElementsByName('short');
  window.localStorage.short = (short[0].checked) ? short[0].value : short[1].value;

  if (window.localStorage.getItem("notify") == "true"){
    var back = chrome.extension.getBackgroundPage();
    back.checkNotifications();
  }

 // I can avoid this for just 2 options
 /*for (var i=0; short.length > i ; i++){
    if(short[i].checked)
      window.localStorage.short = short[i].value;
  }*/
}

function combo(thelist, theinput) {
  theinput = document.getElementById(theinput);  
  var idx = thelist.selectedIndex;
  var content = thelist.options[idx].value;
  theinput.value = content;	
}

function updatePodsRemotely() {
  var i = 0;
  $.get(remoteList, function(data) {
        var remotefilePod = data.split(",");
        $.each(remotefilePod, function() {
           start = this.indexOf("/") + 2;
           end = this.indexOf(" ");
	   podValue = this.substring(0 , end);
           podName = this.substring(start , end);
           pods[i++] = podValue;
	}); // if remote podlist is unreachable, load local podlist
        $("input#pod").autocomplete({source: pods});
  }).error(function() { updatePodsLocally();});
}

function updatePodsLocally(){
  var i = 0;
  $.get(localList, function(data) {
    var filePod = data.split("\n");
    $.each(filePod, function() {
      start = this.indexOf("/") + 2;
      podName = this.substring(0);
      pods[i++] = podName;
    });
    $("input#pod").autocomplete({source: pods}); 
  });
}

function main() {
  localize();

  if (window.localStorage == null) {
    alert(chrome.i18n.getMessage("localStorage"));
    return;
  }

  updatePodsRemotely();
  
  document.getElementById('pod').placeholder = (window.localStorage.podUrl != null) ? window.localStorage.podUrl : defaultPlaceholder;

  document.getElementById('images').checked = (window.localStorage.images != null) ? (window.localStorage.images == "true") : true;
  document.getElementById('markdown').checked = (window.localStorage.markdown != null) ? (window.localStorage.markdown == "true") : true;
  document.getElementById('msg').checked = (window.localStorage.msg != null) ? (window.localStorage.msg == "true") : true;
  document.getElementById('tags').checked = (window.localStorage.tags != null) ? (window.localStorage.tags == "true") : true;
  document.getElementById('title').checked = (window.localStorage.title != null) ? (window.localStorage.title == "true") : true;
  document.getElementById('url').checked = (window.localStorage.url != null) ? (window.localStorage.url == "true") : true;
  document.getElementById('ytimg').checked = (window.localStorage.ytimg != null) ? (window.localStorage.ytimg == "true") : true;
  document.getElementById('vmimg').checked = (window.localStorage.vmimg != null) ? (window.localStorage.vmimg == "true") : true;
  document.getElementById('notify').checked = (window.localStorage.notify != null) ? (window.localStorage.notify == "true") : true;
  document.getElementById('minutes').value = (window.localStorage.minutes != null) ? window.localStorage.minutes : "300000";

  var short = window.localStorage.short;
  if (short == "tiny")
    document.getElementsByName('short')[1].checked = true;
  else
    document.getElementsByName('short')[0].checked = true;
}

</script>
</head>
<body onload="main()">
<center>
<b class="b1"></b><b class="b2"></b><b class="b3"></b><b class="b4"></b>
    <div class="contentb">
    <br>
    <form action="javascript:submit();">
    	<strong><div id="choosePod"></div></strong>
    	<br><br>
    	<input id="pod" name="podurl" size="30" style="font-size: 30px;" class="ui-autocomplete-input"><input type="submit" style="font-size: 30px;">
    	<br><br>
    </form>
    <label id="addImageOpt" for="images" class="optioninput"><input id="images" type="checkbox" onClick="javascript:saveOption()"></label>
    <label id="addMarkdownOpt" for="markdown" class="optioninput"><input id="markdown" type="checkbox" onClick="javascript:saveOption()"></label>
    <label id="addTagsOpt" for="tags" class="optioninput""><input id="tags" type="checkbox" onClick="javascript:saveOption()"></label>
    <label id="addMsgOpt" for="msg" class="optioninput"><input id="msg" type="checkbox" onClick="javascript:saveOption()"></label>
    <br>
    <label id="addTitleOpt" for="title" class="optioninput"><input id="title" type="checkbox" onClick="javascript:saveOption()"></label>
    <label id="addUrlOpt" for="url" class="optioninput"><input id="url" type="checkbox" onClick="javascript:saveOption()"></label>
    <br>
    <label id="addYTOpt" for="ytimg" class="optioninput"><input id="ytimg" type="checkbox" onClick="javascript:saveOption()"></label>
    <label id="addVMOpt" for="vmimg" class="optioninput"><input id="vmimg" type="checkbox" onClick="javascript:saveOption()"></label>
    <br><br>
    <font class="optioninput">Short URL service:</font>
    <label class="optioninput"><input type="radio" id="short" name="short" value="google" onClick="javascript:saveOption()">Goo.gl</label>
    <label class="optioninput"><input type="radio" id="short" name="short" value="tiny" onClick="javascript:saveOption()">Tinyurl.com</label>
    <br><br>
    <label id="enableNotify" for="notify" class="optioninput"><input id="notify" type="checkbox" onClick="javascript:saveOption()"></label>
    <br>
    <label id="checkEvery" class="optioninput"></label><select id="minutes" onChange="javascript:saveOption()">
    <option value="60000">1</option>
    <option value="300000">5</option>
    <option value="600000">10</option>
    <option value="1200000">20</option>
    <option value="1800000">30</option>
    </select><label id="minutes" class="optioninput"></label>
    <br><br>
    </div>
<b class="b4"></b><b class="b3"></b><b class="b2"></b><b class="b1"></b>
</center>
</body>
</html>
